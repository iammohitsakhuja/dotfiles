# Modern tmux configuration.

# =====================================
# General Settings
# =====================================

# Enable true color support (24-bit color)
set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",xterm-256color:RGB"

# Set tmux messages display duration to 2s
set -g display-time 2000

# Enable mouse support
set -g mouse on

# Faster command sequences (decrease delay after escape key)
# Reason for not setting it to 0: https://superuser.com/a/1809494
set -sg escape-time 50

# Increase repeat timeout
set -sg repeat-time 600

# Start windows and panes at 1, not 0
set -g base-index 1
setw -g pane-base-index 1

# Renumber windows when one is closed
set -g renumber-windows on

# Set window title
set -g set-titles on
set -g set-titles-string "#{?#{SSH_CLIENT},#H üåê ,}#S üî∏ #I:#W"

# Monitor activity
set -g monitor-activity off
set -g visual-activity off

# Display pane numbers for longer
set -g display-panes-time 2000

# =====================================
# Key Bindings
# =====================================

# Change prefix from C-b to C-a (easier to reach)
unbind C-b
set -g prefix C-a
bind C-a send-prefix

# Send traditional clear-screen keystroke with no prefix
bind-key -n C-M-l send-keys C-l \; send-keys -R

# Smart pane switching with awareness of vim splits
# Requires vim-tmux-navigator plugin in vim/neovim
# Fzf functionality works because of this awesome blog post: https://smartbear.com/blog/tmux-and-vim/
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
| grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
is_fzf="ps -o state= -o comm= -t '#{pane_tty}' \
  | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?fzf$'"
bind -n C-h run "($is_vim && tmux send-keys C-h) || \
                          tmux select-pane -L"
bind -n C-j run "($is_vim && tmux send-keys C-j)  || \
                         ($is_fzf && tmux send-keys C-j) || \
                         tmux select-pane -D"
bind -n C-k run "($is_vim && tmux send-keys C-k) || \
                          ($is_fzf && tmux send-keys C-k)  || \
                          tmux select-pane -U"
bind -n C-l run "($is_vim && tmux send-keys C-l) || \
                          tmux select-pane -R"
bind-key -n C-\\ if-shell "$is_vim" "send-keys C-\\" "select-pane -l"

# Create new window with current path
bind c new-window -c "#{pane_current_path}"

# Kill pane/window without confirmation
bind x kill-pane
bind X kill-window

# =====================================
# Copy Mode (vi-style)
# =====================================

# Use vi keys in copy mode
setw -g mode-keys vi

# Setup 'v' to begin selection like vim
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel

# Copy to system clipboard (macOS)
# For Linux, use: "xclip -in -selection clipboard"
# For WSL, use: "clip.exe"
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy"

# Make each wheel tick move half a screenful, instead of full screen.
# TODO: Fix or better document certain quirks with these bindings.
bind-key -Tcopy-mode-vi WheelUpPane   send-keys -X halfpage-up
bind-key -Tcopy-mode-vi WheelDownPane send-keys -X halfpage-down

# =====================================
# Tool configuration
# =====================================
# Set these options to allow Yazi to display images correctly in tmux
set -g allow-passthrough on
set -ga update-environment TERM
set -ga update-environment TERM_PROGRAM

# =====================================
# Plugins (using TPM - Tmux Plugin Manager)
# =====================================

# Set plugin installation directory to use XDG data directory
set-environment -g TMUX_PLUGIN_MANAGER_PATH "${XDG_DATA_HOME}/tmux/plugins"

# Install TPM if not already installed:
# git clone https://github.com/tmux-plugins/tpm ${XDG_DATA_HOME}/tmux/plugins/tpm

# List of plugins
set -g @plugin "tmux-plugins/tpm"
set -g @plugin "catppuccin/tmux"
set -g @plugin "tmux-plugins/tmux-sensible"
set -g @plugin "tmux-plugins/tmux-pain-control"
set -g @plugin "tmux-plugins/tmux-resurrect"
set -g @plugin "tmux-plugins/tmux-continuum"
set -g @plugin "tmux-plugins/tmux-yank"
set -g @plugin "christoomey/vim-tmux-navigator"
set -g @plugin "tmux-plugins/tmux-cpu"
set -g @plugin "tmux-plugins/tmux-battery"
set -g @plugin "tmux-plugins/tmux-online-status"

# Plugin configurations
set -g @resurrect-capture-pane-contents "on"
set -g @resurrect-strategy-nvim "session"
set -g @continuum-restore "on"
set -g @continuum-save-interval "15"

# Increase the size for pane resizing set by `pain-control` from 5 to 8
set-option -g @pane_resize "8"

# Catppuccin configuration
set -g @catppuccin_flavor "macchiato"
set -g @catppuccin_status_background "none"
set -g @catppuccin_window_status_style "none"
set -g @catppuccin_pane_status_enabled "off"
set -g @catppuccin_pane_border_status "off"

# =====================================
# Status Bar
# =====================================

# Configure status bar
set -g status-position top
set -g status-justify "absolute-centre"

# Status left look and feel
set -g status-left-length 100
set -g status-left ""
set -ga status-left "#{?client_prefix,#{#[bg=#{@thm_red},fg=#{@thm_bg},bold] ÓØà #S },#{#[bg=#{@thm_bg},fg=#{@thm_green}] ÓØà #S }}"
set -ga status-left "#[bg=#{@thm_bg},fg=#{@thm_overlay_0},none] "
set -ga status-left "#[bg=#{@thm_bg},fg=#{@thm_maroon}] Ó™Ö #{pane_current_command} "
set -ga status-left "#[bg=#{@thm_bg},fg=#{@thm_overlay_0},none] "
set -ga status-left "#[bg=#{@thm_bg},fg=#{@thm_blue}] Ó´∑ #{=/-32/...:#{s|$USER|~|:#{b:pane_current_path}}} "
set -ga status-left "#[bg=#{@thm_bg},fg=#{@thm_overlay_0},none]#{?window_zoomed_flag, ,}"
set -ga status-left "#[bg=#{@thm_bg},fg=#{@thm_yellow}]#{?window_zoomed_flag, Ó≠ø zoom ,}"

# Status right look and feel
set -g status-right-length 100
set -g status-right ""
set -ga status-right "#{?#{e|>=:80,#{cpu_percentage}},#{#[bg=#{@thm_red},fg=#{@thm_bg}]},#{#[bg=#{@thm_bg},fg=#{@thm_green}]}} Ôíº #{cpu_percentage}"
set -ga status-right "#[bg=#{@thm_bg},fg=#{@thm_overlay_0}, none] "
set -ga status-right "#{?#{e|>=:10,#{battery_percentage}},#{#[bg=#{@thm_red},fg=#{@thm_bg}]},#{#[bg=#{@thm_bg},fg=#{@thm_pink}]}} #{battery_icon} #{battery_percentage} "
set -ga status-right "#[bg=#{@thm_bg},fg=#{@thm_overlay_0}, none] "
set -ga status-right "#[bg=#{@thm_bg}]#{?#{==:#{online_status},ok},#[fg=#{@thm_mauve}] Û∞ñ© on ,#[fg=#{@thm_red},bold]#[reverse] Û∞ñ™ off }"
set -ga status-right "#[bg=#{@thm_bg},fg=#{@thm_overlay_0}, none] "
set -ga status-right "#[bg=#{@thm_bg},fg=#{@thm_blue}] Û∞≠¶ %Y-%m-%d Û∞Öê %H:%M "

# =====================================
# Pane
# =====================================

# Pane border look and feel
setw -g pane-border-status top
setw -g pane-border-format ""
setw -g pane-active-border-style "bg=#{@thm_bg},fg=#{@thm_overlay_0}"
setw -g pane-border-style "bg=#{@thm_bg},fg=#{@thm_surface_0}"
setw -g pane-border-lines single

# =====================================
# Window
# =====================================

# Window look and feel
set -wg automatic-rename on
set -g automatic-rename-format "Window"

set -g window-status-format " #I#{?#{!=:#{window_name},Window},: #W,} "
set -g window-status-style "bg=#{@thm_bg},fg=#{@thm_rosewater}"
set -g window-status-last-style "bg=#{@thm_bg},fg=#{@thm_peach}"
set -g window-status-activity-style "bg=#{@thm_red},fg=#{@thm_bg}"
set -g window-status-bell-style "bg=#{@thm_red},fg=#{@thm_bg},bold"
set -gF window-status-separator "#[bg=#{@thm_bg},fg=#{@thm_overlay_0}] "

set -g window-status-current-format " #I#{?#{!=:#{window_name},Window},: #W,} "
set -g window-status-current-style "bg=#{@thm_peach},fg=#{@thm_bg},bold"

# =====================================

# Initialize TPM (keep this line at the very bottom)
run "${XDG_DATA_HOME}/tmux/plugins/tpm/tpm"
